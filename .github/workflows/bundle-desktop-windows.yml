name: "Bundle Desktop (Windows)"

on:
  workflow_dispatch:
  workflow_call:
    inputs:
      version:
        description: 'Version to build'
        required: false
        type: string
      signing:
        description: 'Whether to sign the Windows executable'
        required: false
        type: boolean
        default: false
      ref:
        description: 'Git ref to checkout'
        required: false
        type: string
        default: ''
    secrets:
      WINDOWS_CODESIGN_CERTIFICATE:
        required: false
      WINDOW_SIGNING_ROLE:
        required: false
      WINDOW_SIGNING_ROLE_TAG:
        required: false

# Permissions required for OIDC authentication with AWS
permissions:
  id-token: write   # Required to fetch the OIDC token
  contents: read    # Required by actions/checkout
  actions: read     # May be needed for some workflows

jobs:
  build-desktop-windows:
    name: Build Desktop (Windows)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || '' }}

      - name: Configure AWS credentials
        if: inputs.signing && inputs.signing == true
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708  # v5.1.1
        with:
          role-to-assume: ${{ github.ref == 'refs/heads/main' && secrets.WINDOW_SIGNING_ROLE || secrets.WINDOW_SIGNING_ROLE_TAG }}
          aws-region: us-west-2

      - name: Set up Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: 24.10.0

      - name: Cache node_modules
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7  # v5.0.2
        with:
          path: |
            node_modules
            ui/desktop/node_modules
            .hermit/node/cache
          key: windows-npm-cache-v1-${{ runner.os }}-node24-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            windows-npm-cache-v1-${{ runner.os }}-node24-

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: windows-msvc-desktop

      - name: Setup Rust
        shell: bash
        run: |
          rustup show
          rustup target add x86_64-pc-windows-msvc

      - name: Collect Windows build diagnostics (pre-build)
        shell: bash
        run: |
          set -euo pipefail
          DIAG_DIR="$RUNNER_TEMP/windows-link-diagnostics"
          mkdir -p "$DIAG_DIR"

          {
            echo "runner.os=${RUNNER_OS}"
            echo "runner.arch=${RUNNER_ARCH}"
            echo "github.sha=${GITHUB_SHA}"
            echo "github.ref=${GITHUB_REF}"
            echo "github.run_id=${GITHUB_RUN_ID}"
            echo "github.run_attempt=${GITHUB_RUN_ATTEMPT}"
            echo "RUSTFLAGS=${RUSTFLAGS:-}"
            echo "LLAMA_STATIC_CRT=${LLAMA_STATIC_CRT:-}"
            echo "CMAKE_MSVC_RUNTIME_LIBRARY=${CMAKE_MSVC_RUNTIME_LIBRARY:-}"
            echo "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS=${CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS:-}"
          } > "$DIAG_DIR/env.txt"

          rustc -vV > "$DIAG_DIR/rustc-vV.txt"
          cargo -vV > "$DIAG_DIR/cargo-vV.txt"
          rustup show > "$DIAG_DIR/rustup-show.txt"
          cargo tree --target x86_64-pc-windows-msvc -e features -i tokenizers > "$DIAG_DIR/cargo-tree-tokenizers.txt" || true
          cargo tree --target x86_64-pc-windows-msvc -e features -i llama-cpp-sys-2 > "$DIAG_DIR/cargo-tree-llama.txt" || true
          cargo tree --target x86_64-pc-windows-msvc -e features -i esaxx-rs > "$DIAG_DIR/cargo-tree-esaxx.txt" || true

      - name: Build Windows executable
        shell: bash
        run: |
          set -euo pipefail
          DIAG_DIR="$RUNNER_TEMP/windows-link-diagnostics"
          mkdir -p "$DIAG_DIR"
          echo "üöÄ Building Windows executable..."
          set +e
          cargo build --release --target x86_64-pc-windows-msvc --verbose 2>&1 | tee "$DIAG_DIR/cargo-build.log"
          build_exit=${PIPESTATUS[0]}
          set -e

          # Verify build succeeded
          if [ "$build_exit" -ne 0 ] || [ ! -f "./target/x86_64-pc-windows-msvc/release/goosed.exe" ]; then
            echo "‚ùå Windows binary not found."
            ls -la ./target/x86_64-pc-windows-msvc/release/ || echo "Release directory doesn't exist"
            rg -n "LNK2038|LNK2005|LNK1169|RuntimeLibrary|error: linking with link\\.exe failed" "$DIAG_DIR/cargo-build.log" > "$DIAG_DIR/linker-signatures.txt" || true
            exit 1
          fi

          echo "‚úÖ Windows binary found!"
          ls -la ./target/x86_64-pc-windows-msvc/release/goosed.exe

      - name: Upload Windows linker diagnostics
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: windows-link-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ runner.temp }}/windows-link-diagnostics/**
          if-no-files-found: warn

      - name: Prepare Windows binary
        shell: bash
        run: |
          if [ ! -f "./target/x86_64-pc-windows-msvc/release/goosed.exe" ]; then
            echo "Windows binary not found."
            exit 1
          fi

          echo "Cleaning destination directory..."
          rm -rf ./ui/desktop/src/bin
          mkdir -p ./ui/desktop/src/bin

          echo "Copying Windows binary..."
          cp -f ./target/x86_64-pc-windows-msvc/release/goosed.exe ./ui/desktop/src/bin/

          if [ -d "./ui/desktop/src/platform/windows/bin" ]; then
            echo "Copying Windows platform files..."
            for file in ./ui/desktop/src/platform/windows/bin/*.{exe,dll,cmd}; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "goosed.exe" ]; then
                cp -f "$file" ./ui/desktop/src/bin/
              fi
            done

            if [ -d "./ui/desktop/src/platform/windows/bin/goose-npm" ]; then
              echo "Setting up npm environment..."
              cp -r ./ui/desktop/src/platform/windows/bin/goose-npm/ ./ui/desktop/src/bin/goose-npm/
            fi
            echo "Windows-specific files copied successfully"
          fi

      - name: Force GitHub HTTPS for npm git dependencies
        shell: bash
        run: |
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "git+ssh://git@github.com/"

      - name: Build desktop UI with npm
        shell: bash
        env:
          ELECTRON_PLATFORM: win32
        run: |
          cd ui/desktop

          npm install
          node scripts/build-main.js
          node scripts/prepare-platform-binaries.js
          npm run make -- --platform=win32 --arch=x64

      - name: Copy exe to final out folder and prepare flat distribution
        shell: bash
        run: |
          cd ui/desktop
          mkdir -p ./out/Goose-win32-x64/resources/bin
          cp -r src/bin/* out/Goose-win32-x64/resources/bin/

          mkdir -p ./dist-windows
          cp -r ./out/Goose-win32-x64/* ./dist-windows/

          echo "üìã Final flat distribution structure:"
          ls -la ./dist-windows/
          echo "üìã Binary files in resources/bin:"
          ls -la ./dist-windows/resources/bin/

      - name: Setup Java for signing
        if: inputs.signing && inputs.signing == true
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00  # v4.7.1
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Sign Windows executables with jsign + AWS KMS
        if: inputs.signing && inputs.signing == true
        shell: bash
        run: |
          set -exuo pipefail
          echo "üîê Starting Windows code signing with jsign + AWS KMS..."

          echo "üìù Creating certificate file from GitHub secret..."
          echo "${{ secrets.WINDOWS_CODESIGN_CERTIFICATE }}" > block-codesign-cert.pem

          # Download jsign
          echo "üì• Downloading jsign..."
          curl -sL https://github.com/ebourg/jsign/releases/download/6.0/jsign-6.0.jar -o jsign.jar
          echo "05ca18d4ab7b8c2183289b5378d32860f0ea0f3bdab1f1b8cae5894fb225fa8a  jsign.jar" | sha256sum -c

          echo "üîê Signing main Electron executable: Goose.exe"
          cd ui/desktop/dist-windows/

          java -jar ${GITHUB_WORKSPACE}/jsign.jar \
            --storetype AWS \
            --keystore us-west-2 \
            --storepass "${AWS_ACCESS_KEY_ID}|${AWS_SECRET_ACCESS_KEY}|${AWS_SESSION_TOKEN}" \
            --alias windows-codesign \
            --certfile "${GITHUB_WORKSPACE}/block-codesign-cert.pem" \
            --tsaurl "http://timestamp.digicert.com" \
            --name "Goose" \
            --url "https://github.com/block/goose" \
            "Goose.exe"

          echo "‚úÖ Main executable Goose.exe signed successfully"

          echo "üîê Signing backend executable: goosed.exe"
          cd resources/bin/

          java -jar ${GITHUB_WORKSPACE}/jsign.jar \
            --storetype AWS \
            --keystore us-west-2 \
            --storepass "${AWS_ACCESS_KEY_ID}|${AWS_SECRET_ACCESS_KEY}|${AWS_SESSION_TOKEN}" \
            --alias windows-codesign \
            --certfile "${GITHUB_WORKSPACE}/block-codesign-cert.pem" \
            --tsaurl "http://timestamp.digicert.com" \
            --name "Goose Backend" \
            --url "https://github.com/block/goose" \
            "goosed.exe"

          echo "‚úÖ Backend executable goosed.exe signed successfully"

          # Show final file status
          echo "üìã Final signed files:"
          cd ../../
          ls -la Goose.exe
          sha256sum Goose.exe
          ls -la resources/bin/goosed.exe
          sha256sum resources/bin/goosed.exe

          rm -f ${GITHUB_WORKSPACE}/block-codesign-cert.pem

      - name: Verify signed executables are in final distribution
        if: inputs.signing && inputs.signing == true
        shell: pwsh
        run: |
          echo "üìã Verifying both signed executables in final distribution:"
          echo "Main executable:"
          Get-Item ui/desktop/dist-windows/Goose.exe
          $sig = Get-AuthenticodeSignature ui/desktop/dist-windows/Goose.exe
          if ($sig.Status -ne "Valid") { throw "Main executable signature invalid: $($sig.Status)" }
          echo "‚úÖ Main executable signature verification passed"

          echo "Backend executable:"
          Get-Item ui/desktop/dist-windows/resources/bin/goosed.exe
          $sig = Get-AuthenticodeSignature ui/desktop/dist-windows/resources/bin/goosed.exe
          if ($sig.Status -ne "Valid") { throw "Backend executable signature invalid: $($sig.Status)" }
          echo "‚úÖ Backend executable signature verification passed"

      - name: Create Windows zip package
        shell: bash
        run: |
          cd ui/desktop
          echo "üì¶ Creating Windows zip package..."

          7z a -tzip "Goose-win32-x64.zip" dist-windows/

          echo "‚úÖ Windows zip package created:"
          ls -la Goose-win32-x64.zip

          mkdir -p out/Goose-win32-x64/
          cp Goose-win32-x64.zip out/Goose-win32-x64/

      - name: Upload Windows build artifacts
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f  # v6.0.0
        with:
          name: Goose-win32-x64
          path: ui/desktop/out/Goose-win32-x64/Goose-win32-x64.zip
