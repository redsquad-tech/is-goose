name: "Bundle Desktop Installers (MSI + DMG)"

on:
  push:
    paths-ignore:
      - "documentation/**"
    tags:
      - "v1.*"
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Defaults to current ref.'
        required: false
        type: string
        default: ''
      version:
        description: 'Optional version to set before build (example: 1.24.1)'
        required: false
        type: string
        default: ''
      mac_arch:
        description: 'macOS architecture to build'
        required: false
        type: choice
        options:
          - arm64
          - x64
        default: arm64
      signing:
        description: 'Enable signing stage (currently documented, not automated in this workflow)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      ref:
        required: false
        type: string
        default: ''
      version:
        required: false
        type: string
        default: ''
      mac_arch:
        required: false
        type: string
        default: arm64
      signing:
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-windows-msi:
    name: Build Windows MSI
    runs-on: windows-latest
    env:
      GOOSE_BUNDLE_NAME: ${{ vars.GOOSE_BUNDLE_NAME }}
      GOOSE_LOCALE: ${{ vars.GOOSE_LOCALE }}

    steps:
      - name: Set repository env
        shell: bash
        run: |
          echo "GITHUB_OWNER=${{ github.repository_owner }}" >> "$GITHUB_ENV"
          echo "GITHUB_REPO=${{ github.event.repository.name }}" >> "$GITHUB_ENV"

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24.10.0

      - name: Cache node_modules
        uses: actions/cache@8b402f58fbc84540c8b491a91e594a4576fec3d7 # v5.0.2
        with:
          path: |
            node_modules
            ui/desktop/node_modules
            .hermit/node/cache
          key: windows-npm-cache-v1-${{ runner.os }}-node24-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            windows-npm-cache-v1-${{ runner.os }}-node24-

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: windows-msi

      - name: Setup Rust target
        shell: bash
        run: |
          rustup target add x86_64-pc-windows-msvc

      - name: Collect Windows build diagnostics (pre-build)
        shell: bash
        run: |
          set -euo pipefail
          DIAG_DIR="$RUNNER_TEMP/windows-link-diagnostics"
          mkdir -p "$DIAG_DIR"

          {
            echo "runner.os=${RUNNER_OS}"
            echo "runner.arch=${RUNNER_ARCH}"
            echo "github.sha=${GITHUB_SHA}"
            echo "github.ref=${GITHUB_REF}"
            echo "github.run_id=${GITHUB_RUN_ID}"
            echo "github.run_attempt=${GITHUB_RUN_ATTEMPT}"
            echo "RUSTFLAGS=${RUSTFLAGS:-}"
            echo "LLAMA_STATIC_CRT=${LLAMA_STATIC_CRT:-}"
            echo "CMAKE_MSVC_RUNTIME_LIBRARY=${CMAKE_MSVC_RUNTIME_LIBRARY:-}"
            echo "CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS=${CARGO_TARGET_X86_64_PC_WINDOWS_MSVC_RUSTFLAGS:-}"
          } > "$DIAG_DIR/env.txt"

          rustc -vV > "$DIAG_DIR/rustc-vV.txt"
          cargo -vV > "$DIAG_DIR/cargo-vV.txt"
          rustup show > "$DIAG_DIR/rustup-show.txt"
          cargo tree --target x86_64-pc-windows-msvc -e features -i tokenizers > "$DIAG_DIR/cargo-tree-tokenizers.txt" || true
          cargo tree --target x86_64-pc-windows-msvc -e features -i llama-cpp-sys-2 > "$DIAG_DIR/cargo-tree-llama.txt" || true
          cargo tree --target x86_64-pc-windows-msvc -e features -i esaxx-rs > "$DIAG_DIR/cargo-tree-esaxx.txt" || true

      - name: Update versions
        if: ${{ inputs.version != '' }}
        shell: bash
        run: |
          sed -i.bak "s/^version = \".*\"/version = \"${{ inputs.version }}\"/" Cargo.toml
          rm -f Cargo.toml.bak
          cd ui/desktop
          npm version "${{ inputs.version }}" --no-git-tag-version --allow-same-version

      - name: Build goosed (Windows)
        shell: bash
        env:
          LLAMA_STATIC_CRT: "OFF"
          CMAKE_MSVC_RUNTIME_LIBRARY: MultiThreadedDLL
          CMAKE_ARGS: -DLLAMA_STATIC_CRT=OFF -DCMAKE_MSVC_RUNTIME_LIBRARY=MultiThreadedDLL
        run: |
          set -euo pipefail
          DIAG_DIR="$RUNNER_TEMP/windows-link-diagnostics"
          mkdir -p "$DIAG_DIR"
          set +e
          cargo build --release -p goose-server --target x86_64-pc-windows-msvc --verbose 2>&1 | tee "$DIAG_DIR/cargo-build.log"
          build_exit=${PIPESTATUS[0]}
          set -e
          if [ "$build_exit" -ne 0 ]; then
            if command -v rg >/dev/null 2>&1; then
              rg -n "LNK2038|LNK2005|LNK1169|RuntimeLibrary|error: linking with link\\.exe failed" "$DIAG_DIR/cargo-build.log" > "$DIAG_DIR/linker-signatures.txt" || true
            else
              grep -En "LNK2038|LNK2005|LNK1169|RuntimeLibrary|error: linking with link\\.exe failed" "$DIAG_DIR/cargo-build.log" > "$DIAG_DIR/linker-signatures.txt" || true
            fi
            exit 1
          fi

      - name: Upload Windows linker diagnostics
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: windows-link-diagnostics-${{ github.run_id }}-${{ github.run_attempt }}
          path: ${{ runner.temp }}/windows-link-diagnostics/**
          if-no-files-found: warn

      - name: Prepare Windows binary
        shell: bash
        run: |
          if [ ! -f "./target/x86_64-pc-windows-msvc/release/goosed.exe" ]; then
            echo "Windows binary not found."
            exit 1
          fi

          rm -rf ./ui/desktop/src/bin
          mkdir -p ./ui/desktop/src/bin
          cp -f ./target/x86_64-pc-windows-msvc/release/goosed.exe ./ui/desktop/src/bin/

          if [ -d "./ui/desktop/src/platform/windows/bin" ]; then
            for file in ./ui/desktop/src/platform/windows/bin/*.{exe,dll,cmd}; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "goosed.exe" ]; then
                cp -f "$file" ./ui/desktop/src/bin/
              fi
            done
            if [ -d "./ui/desktop/src/platform/windows/bin/goose-npm" ]; then
              cp -r ./ui/desktop/src/platform/windows/bin/goose-npm/ ./ui/desktop/src/bin/goose-npm/
            fi
          fi

      - name: Force GitHub HTTPS for npm git dependencies
        shell: bash
        run: |
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "git+ssh://git@github.com/"

      - name: Install desktop dependencies
        shell: bash
        run: |
          cd ui/desktop
          npm ci

      - name: Build Windows ZIP package (intermediate)
        shell: bash
        env:
          ELECTRON_PLATFORM: win32
        run: |
          cd ui/desktop
          node scripts/build-main.js
          node scripts/prepare-platform-binaries.js
          npm run make -- --platform=win32 --arch=x64 --targets=@electron-forge/maker-zip
          echo "ZIP outputs:"
          find out/make -type f -name '*.zip' -print

      - name: Install WiX Toolset
        shell: powershell
        run: |
          choco install wixtoolset --no-progress -y

      - name: Build MSI installer
        shell: bash
        env:
          ELECTRON_PLATFORM: win32
        run: |
          cd ui/desktop
          npm run make -- --platform=win32 --arch=x64 --targets=@electron-forge/maker-wix

      - name: Upload MSI artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ISGuce-win32-x64-msi
          path: ui/desktop/out/make/wix/x64/*.msi
          if-no-files-found: error

  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    environment: release
    env:
      GOOSE_BUNDLE_NAME: ${{ vars.GOOSE_BUNDLE_NAME }}
      GOOSE_LOCALE: ${{ vars.GOOSE_LOCALE }}
      MAC_ARCH: ${{ inputs.mac_arch != '' && inputs.mac_arch || 'arm64' }}

    steps:
      - name: Set repository env
        run: |
          echo "GITHUB_OWNER=${{ github.repository_owner }}" >> "$GITHUB_ENV"
          echo "GITHUB_REPO=${{ github.event.repository.name }}" >> "$GITHUB_ENV"

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || '' }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: macos-dmg

      - name: Setup Rust target
        run: |
          if [ "${MAC_ARCH}" = "x64" ]; then
            rustup target add x86_64-apple-darwin
            echo "RUST_TARGET=x86_64-apple-darwin" >> "$GITHUB_ENV"
          else
            rustup target add aarch64-apple-darwin
            echo "RUST_TARGET=aarch64-apple-darwin" >> "$GITHUB_ENV"
          fi

      - name: Update versions
        if: ${{ inputs.version != '' }}
        run: |
          sed -i.bak "s/^version = \".*\"/version = \"${{ inputs.version }}\"/" Cargo.toml
          rm -f Cargo.toml.bak
          cd ui/desktop
          npm version "${{ inputs.version }}" --no-git-tag-version --allow-same-version

      - name: Build goosed (macOS)
        run: |
          source ./bin/activate-hermit
          cargo build --release -p goose-server --target "${RUST_TARGET}"
          mkdir -p ui/desktop/src/bin
          cp "target/${RUST_TARGET}/release/goosed" ui/desktop/src/bin/goosed

      - name: Build DMG installer
        run: |
          source ./bin/activate-hermit
          cd ui/desktop
          npm ci
          npm run make -- --platform=darwin --arch="${MAC_ARCH}"

      - name: Sign and notarize macOS artifacts (Individual API key)
        env:
          APPLE_API_KEY_ID: ${{ vars.APPLE_API_KEY_ID }}
          APPLE_API_ISSUER_ID: ${{ vars.APPLE_API_ISSUER_ID }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64 }}
          APPLE_DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_APP_CERT_PASSWORD }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          cd ui/desktop

          if [ -z "${APPLE_API_KEY_ID:-}" ] || [ -z "${APPLE_TEAM_ID:-}" ] || [ -z "${APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64:-}" ] || [ -z "${APPLE_DEVELOPER_ID_APP_CERT_PASSWORD:-}" ] || [ -z "${APPLE_API_PRIVATE_KEY_P8_BASE64:-}" ]; then
            echo "Missing required Apple signing/notarization env values"
            exit 1
          fi

          KEYCHAIN_PATH="$RUNNER_TEMP/build-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 24)"
          CERT_PATH="$RUNNER_TEMP/dev-id.p12"
          API_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID}.p8"

          echo "$APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH" 2>/dev/null || echo "$APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64" | base64 -D > "$CERT_PATH"
          echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 --decode > "$API_KEY_PATH" 2>/dev/null || echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 -D > "$API_KEY_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_DEVELOPER_ID_APP_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          IDENTITY="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep 'Developer ID Application' | head -n1 | sed -E 's/.*\"(.*)\".*/\1/')"
          if [ -z "$IDENTITY" ]; then
            echo "Developer ID Application identity not found in imported keychain"
            exit 1
          fi

          APP_PATH="$(find out -type d -name '*.app' | head -n1)"
          ORIGINAL_DMG_PATH="$(find out/make -type f -name '*.dmg' | head -n1)"

          if [ -z "$APP_PATH" ]; then
            echo "Could not find app artifact for signing"
            exit 1
          fi

          if [ -n "$ORIGINAL_DMG_PATH" ]; then
            echo "Original unsigned DMG: $ORIGINAL_DMG_PATH"
          fi

          xattr -cr "$APP_PATH"

          # Sign nested Mach-O binaries first (Electron libs, helper binaries, bundled goosed, etc.).
          while IFS= read -r -d '' file; do
            if file "$file" | grep -q "Mach-O"; then
              codesign --force --options runtime --timestamp --sign "$IDENTITY" "$file"
            fi
          done < <(find "$APP_PATH/Contents" -type f -print0)

          # Then sign nested bundles/frameworks, and finally the app bundle.
          while IFS= read -r -d '' bundle; do
            codesign --force --options runtime --timestamp --sign "$IDENTITY" "$bundle"
          done < <(find "$APP_PATH/Contents" -type d \( -name "*.app" -o -name "*.framework" -o -name "*.xpc" \) -print0 | sort -z -r)

          codesign --force --options runtime --timestamp --sign "$IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"
          # Before notarization this commonly reports "Unnotarized Developer ID".
          # Keep it informational so we fail only on signing/notarization errors.
          spctl -a -t exec -v "$APP_PATH" || true

          APP_NAME="$(basename "$APP_PATH" .app)"
          DMG_PATH="$RUNNER_TEMP/${APP_NAME}-${MAC_ARCH}-signed.dmg"
          hdiutil create -volname "$APP_NAME" -srcfolder "$APP_PATH" -ov -format UDZO "$DMG_PATH"
          # DMG itself must be signed, otherwise post-staple spctl may report "no usable signature".
          codesign --force --timestamp --sign "$IDENTITY" "$DMG_PATH"
          codesign --verify --verbose=2 "$DMG_PATH"

          SUBMIT_JSON="$RUNNER_TEMP/notary-submit.json"
          WAIT_JSON="$RUNNER_TEMP/notary-wait.json"
          LOG_JSON="$RUNNER_TEMP/notary-log.json"

          run_notary_cycle() {
            local submit_exit
            local wait_exit
            local status

            local -a auth_args=(--key "$API_KEY_PATH" --key-id "$APPLE_API_KEY_ID" --issuer "$APPLE_API_ISSUER_ID")

            set +e
            xcrun notarytool submit "$DMG_PATH" "${auth_args[@]}" --output-format json > "$SUBMIT_JSON"
            submit_exit=$?
            set -e
            if [ "$submit_exit" -ne 0 ]; then
              echo "Notary submit failed (exit=$submit_exit)"
              cat "$SUBMIT_JSON" || true
              return 1
            fi

            SUBMISSION_ID="$(jq -r '.id // empty' "$SUBMIT_JSON")"
            if [ -z "$SUBMISSION_ID" ]; then
              echo "Notary submission id is missing"
              cat "$SUBMIT_JSON" || true
              return 1
            fi
            echo "Notary submission id: $SUBMISSION_ID"

            set +e
            xcrun notarytool wait "$SUBMISSION_ID" "${auth_args[@]}" --output-format json > "$WAIT_JSON"
            wait_exit=$?
            set -e

            status="$(jq -r '.status // empty' "$WAIT_JSON")"
            if [ "$wait_exit" -ne 0 ] || [ "$status" != "Accepted" ]; then
              echo "Notarization failed. status=${status:-unknown}, exit=$wait_exit"
              xcrun notarytool log "$SUBMISSION_ID" "${auth_args[@]}" --output-format json > "$LOG_JSON" || true
              echo "Notary detailed log:"
              cat "$LOG_JSON" || true
              return 1
            fi

            return 0
          }

          run_notary_cycle

          xcrun stapler staple "$DMG_PATH"
          spctl -a -t open --context context:primary-signature -v "$DMG_PATH"

          mkdir -p out/make/signed
          cp -f "$DMG_PATH" "out/make/signed/$(basename "$DMG_PATH")"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ISGuce-darwin-${{ env.MAC_ARCH }}-dmg
          path: ui/desktop/out/make/**/*.dmg
          if-no-files-found: error

  signing-note:
    name: Signing note
    if: ${{ (github.event_name == 'push' || inputs.signing) && vars.DESKTOP_SIGNING_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows-msi
      - build-macos-dmg
    steps:
      - name: Signing status
        run: |
          echo "Signing was requested, but this workflow currently automates only macOS notarization mode:"
          echo "MAC_SIGNING_MODE=notarytool_individual"

  publish-release:
    name: Publish MSI/DMG Release Assets
    if: ${{ startsWith(github.ref, 'refs/tags/v1.') }}
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows-msi
      - build-macos-dmg
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          merge-multiple: true

      - name: Attest build provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            *.msi
            *.dmg

      - name: Release versioned
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            *.msi
            *.dmg
          allowUpdates: true
          omitBody: true
          omitPrereleaseDuringUpdate: true

      - name: Release stable
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: stable
          name: Stable
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            *.msi
            *.dmg
          allowUpdates: true
          omitBody: true
          omitPrereleaseDuringUpdate: true
