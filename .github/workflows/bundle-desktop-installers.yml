name: "Bundle Desktop Installers (MSI + DMG)"

on:
  push:
    paths-ignore:
      - "documentation/**"
    tags:
      - "v1.*"
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to checkout (branch, tag, or SHA). Defaults to current ref.'
        required: false
        type: string
        default: ''
      version:
        description: 'Optional version to set before build (example: 1.24.1)'
        required: false
        type: string
        default: ''
      mac_arch:
        description: 'macOS architecture to build'
        required: false
        type: choice
        options:
          - arm64
          - x64
        default: arm64
      signing:
        description: 'Enable signing stage (currently documented, not automated in this workflow)'
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      ref:
        required: false
        type: string
        default: ''
      version:
        required: false
        type: string
        default: ''
      mac_arch:
        required: false
        type: string
        default: arm64
      signing:
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  id-token: write
  attestations: write

jobs:
  build-windows-msi:
    name: Build Windows MSI
    runs-on: windows-latest
    env:
      GOOSE_BUNDLE_NAME: ${{ vars.GOOSE_BUNDLE_NAME }}
      GOOSE_LOCALE: ${{ vars.GOOSE_LOCALE }}
      CMAKE_MSVC_RUNTIME_LIBRARY: MultiThreadedDLL

    steps:
      - name: Set repository env
        shell: bash
        run: |
          echo "GITHUB_OWNER=${{ github.repository_owner }}" >> "$GITHUB_ENV"
          echo "GITHUB_REPO=${{ github.event.repository.name }}" >> "$GITHUB_ENV"

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || '' }}

      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238 # v6.2.0
        with:
          node-version: 24.10.0

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: windows-msi

      - name: Setup Rust target
        shell: bash
        run: |
          rustup target add x86_64-pc-windows-msvc

      - name: Update versions
        if: ${{ inputs.version != '' }}
        shell: bash
        run: |
          sed -i.bak "s/^version = \".*\"/version = \"${{ inputs.version }}\"/" Cargo.toml
          rm -f Cargo.toml.bak
          cd ui/desktop
          npm version "${{ inputs.version }}" --no-git-tag-version --allow-same-version

      - name: Build goosed (Windows)
        shell: bash
        run: |
          cargo build --release --target x86_64-pc-windows-msvc -p goose-server
          mkdir -p ui/desktop/src/bin
          cp target/x86_64-pc-windows-msvc/release/goosed.exe ui/desktop/src/bin/goosed.exe

      - name: Install WiX Toolset
        shell: powershell
        run: |
          choco install wixtoolset --no-progress -y

      - name: Build MSI installer
        shell: bash
        run: |
          cd ui/desktop
          npm ci
          npm run make -- --platform=win32 --arch=x64

      - name: Upload MSI artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ISGuce-win32-x64-msi
          path: ui/desktop/out/make/wix/x64/*.msi
          if-no-files-found: error

  build-macos-dmg:
    name: Build macOS DMG
    runs-on: macos-latest
    environment: release
    env:
      GOOSE_BUNDLE_NAME: ${{ vars.GOOSE_BUNDLE_NAME }}
      GOOSE_LOCALE: ${{ vars.GOOSE_LOCALE }}
      MAC_ARCH: ${{ inputs.mac_arch != '' && inputs.mac_arch || 'arm64' }}

    steps:
      - name: Set repository env
        run: |
          echo "GITHUB_OWNER=${{ github.repository_owner }}" >> "$GITHUB_ENV"
          echo "GITHUB_REPO=${{ github.event.repository.name }}" >> "$GITHUB_ENV"

      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.ref != '' && inputs.ref || '' }}

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          key: macos-dmg

      - name: Setup Rust target
        run: |
          if [ "${MAC_ARCH}" = "x64" ]; then
            rustup target add x86_64-apple-darwin
            echo "RUST_TARGET=x86_64-apple-darwin" >> "$GITHUB_ENV"
          else
            rustup target add aarch64-apple-darwin
            echo "RUST_TARGET=aarch64-apple-darwin" >> "$GITHUB_ENV"
          fi

      - name: Update versions
        if: ${{ inputs.version != '' }}
        run: |
          sed -i.bak "s/^version = \".*\"/version = \"${{ inputs.version }}\"/" Cargo.toml
          rm -f Cargo.toml.bak
          cd ui/desktop
          npm version "${{ inputs.version }}" --no-git-tag-version --allow-same-version

      - name: Build goosed (macOS)
        run: |
          source ./bin/activate-hermit
          cargo build --release -p goose-server --target "${RUST_TARGET}"
          mkdir -p ui/desktop/src/bin
          cp "target/${RUST_TARGET}/release/goosed" ui/desktop/src/bin/goosed

      - name: Build DMG installer
        run: |
          source ./bin/activate-hermit
          cd ui/desktop
          npm ci
          npm run make -- --platform=darwin --arch="${MAC_ARCH}"

      - name: Sign and notarize macOS artifacts (Individual API key)
        if: ${{ (github.event_name == 'push' || inputs.signing) && vars.DESKTOP_SIGNING_ENABLED == 'true' && vars.MAC_SIGNING_MODE == 'notarytool_individual' }}
        env:
          APPLE_API_KEY_ID: ${{ vars.APPLE_API_KEY_ID }}
          APPLE_TEAM_ID: ${{ vars.APPLE_TEAM_ID }}
          APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64: ${{ secrets.APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64 }}
          APPLE_DEVELOPER_ID_APP_CERT_PASSWORD: ${{ secrets.APPLE_DEVELOPER_ID_APP_CERT_PASSWORD }}
          APPLE_API_PRIVATE_KEY_P8_BASE64: ${{ secrets.APPLE_API_PRIVATE_KEY_P8_BASE64 }}
        run: |
          set -euo pipefail
          cd ui/desktop

          if [ -z "${APPLE_API_KEY_ID:-}" ] || [ -z "${APPLE_TEAM_ID:-}" ] || [ -z "${APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64:-}" ] || [ -z "${APPLE_DEVELOPER_ID_APP_CERT_PASSWORD:-}" ] || [ -z "${APPLE_API_PRIVATE_KEY_P8_BASE64:-}" ]; then
            echo "Missing required Apple signing/notarization env values"
            exit 1
          fi

          KEYCHAIN_PATH="$RUNNER_TEMP/build-signing.keychain-db"
          KEYCHAIN_PASSWORD="$(openssl rand -hex 24)"
          CERT_PATH="$RUNNER_TEMP/dev-id.p12"
          API_KEY_PATH="$RUNNER_TEMP/AuthKey_${APPLE_API_KEY_ID}.p8"

          echo "$APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64" | base64 --decode > "$CERT_PATH" 2>/dev/null || echo "$APPLE_DEVELOPER_ID_APP_CERT_P12_BASE64" | base64 -D > "$CERT_PATH"
          echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 --decode > "$API_KEY_PATH" 2>/dev/null || echo "$APPLE_API_PRIVATE_KEY_P8_BASE64" | base64 -D > "$API_KEY_PATH"

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -s "$KEYCHAIN_PATH"

          security import "$CERT_PATH" -k "$KEYCHAIN_PATH" -P "$APPLE_DEVELOPER_ID_APP_CERT_PASSWORD" -T /usr/bin/codesign -T /usr/bin/security
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          IDENTITY="$(security find-identity -v -p codesigning "$KEYCHAIN_PATH" | grep 'Developer ID Application' | head -n1 | sed -E 's/.*\"(.*)\".*/\1/')"
          if [ -z "$IDENTITY" ]; then
            echo "Developer ID Application identity not found in imported keychain"
            exit 1
          fi

          APP_PATH="$(find out -type d -name '*.app' | head -n1)"
          DMG_PATH="$(find out/make -type f -name '*.dmg' | head -n1)"

          if [ -z "$APP_PATH" ] || [ -z "$DMG_PATH" ]; then
            echo "Could not find app or dmg artifact for signing"
            exit 1
          fi

          codesign --force --deep --options runtime --timestamp --sign "$IDENTITY" "$APP_PATH"
          codesign --verify --deep --strict --verbose=2 "$APP_PATH"

          xcrun notarytool submit "$DMG_PATH" --key "$API_KEY_PATH" --key-id "$APPLE_API_KEY_ID" --team-id "$APPLE_TEAM_ID" --wait
          xcrun stapler staple "$DMG_PATH"
          spctl -a -t open --context context:primary-signature -v "$DMG_PATH"

      - name: Upload DMG artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: ISGuce-darwin-${{ env.MAC_ARCH }}-dmg
          path: ui/desktop/out/make/**/*.dmg
          if-no-files-found: error

  signing-note:
    name: Signing note
    if: ${{ (github.event_name == 'push' || inputs.signing) && vars.DESKTOP_SIGNING_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows-msi
      - build-macos-dmg
    steps:
      - name: Signing status
        run: |
          echo "Signing was requested, but this workflow currently automates only macOS notarization mode:"
          echo "MAC_SIGNING_MODE=notarytool_individual"

  publish-release:
    name: Publish MSI/DMG Release Assets
    if: ${{ startsWith(github.ref, 'refs/tags/v1.') }}
    runs-on: ubuntu-latest
    environment: release
    needs:
      - build-windows-msi
      - build-macos-dmg
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          merge-multiple: true

      - name: Attest build provenance
        uses: actions/attest-build-provenance@96278af6caaf10aea03fd8d33a09a777ca52d62f # v3.2.0
        with:
          subject-path: |
            *.msi
            *.dmg

      - name: Release versioned
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            *.msi
            *.dmg
          allowUpdates: true
          omitBody: true
          omitPrereleaseDuringUpdate: true

      - name: Release stable
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          tag: stable
          name: Stable
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            *.msi
            *.dmg
          allowUpdates: true
          omitBody: true
          omitPrereleaseDuringUpdate: true
