name: Bundle Desktop Artifacts (Conference Signed)

on:
  push:
    branches:
      - distro
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bundle-desktop:
    uses: ./.github/workflows/bundle-desktop.yml
    permissions:
      id-token: write
      contents: read
    with:
      signing: ${{ secrets.OSX_CODESIGN_ROLE != '' }}
    secrets:
      OSX_CODESIGN_ROLE: ${{ secrets.OSX_CODESIGN_ROLE }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  bundle-desktop-intel:
    uses: ./.github/workflows/bundle-desktop-intel.yml
    permissions:
      id-token: write
      contents: read
    with:
      signing: ${{ secrets.OSX_CODESIGN_ROLE != '' }}
    secrets:
      OSX_CODESIGN_ROLE: ${{ secrets.OSX_CODESIGN_ROLE }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

  bundle-desktop-windows:
    uses: ./.github/workflows/bundle-desktop-windows.yml
    with:
      signing: false

  release-conference:
    name: Publish Desktop Bundles to Conference Release
    runs-on: ubuntu-latest
    needs: [bundle-desktop, bundle-desktop-intel, bundle-desktop-windows]
    permissions:
      contents: write
    steps:
      - name: Download all workflow artifacts
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131  # v7.0.0
        with:
          merge-multiple: true

      - name: List release assets
        run: ls -la

      - name: Publish conference release
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b  # v1.20.0
        with:
          tag: stable-conference
          name: Stable (Conference)
          token: ${{ secrets.GITHUB_TOKEN }}
          artifacts: |
            InsightStream-goose-macos-arm64.zip
            InsightStream-goose-macos-x64.zip
            InsightStream-goose-windows-x64.zip
          allowUpdates: true
          replacesArtifacts: true
          makeLatest: false
          omitBody: true
          omitPrereleaseDuringUpdate: true
